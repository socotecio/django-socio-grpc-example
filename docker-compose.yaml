version: "3.1"

services:

  database:
    image: postgres:16.1
    command: postgres -c 'max_connections=1000'
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres

  dsg-example-back:
    build:
      context: ./backend
    command: /opt/code/manage.py runserver 0.0.0.0:80
    # command: django-admin startproject dsg_example .
    # command: python manage.py startapp async_example_bib_app
    volumes:
      - ./backend:/opt/code
    ports:
      - "9080:80"
    env_file:
      - ./backend/.env

  dsg-example-grpc:
    build:
      context: ./backend
    command: /opt/code/manage.py grpcrunaioserver
    volumes:
      - ./backend:/opt/code
    ports:
      - "50051:50051"
    env_file:
      - ./backend/.env

  envoy:
    build:
      context: ./
      dockerfile: ./envoy/Dockerfile
    image: grpcweb/envoy
    volumes:
      - ./envoy:/etc/envoy
    ports:
      - "9001:9001"


  # ---------------------------- Front -------------------------------------------

  dsg-example-front:
    image: dsg-example-front
    container_name: dsg-example-front
    ports:
      - "5173:5173"
    build:
      context: ./frontend/grpc-web-example
    volumes:
      - ./frontend/grpc-web-example:/opt/code
      - /opt/code/node_modules
    command: dev -- --host
